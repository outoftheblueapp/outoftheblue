<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Out of the Blue</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --deep:#0f172a; --sea:#4fc3dc; --sea-600:#36b2cd; --sand:#fff7e6; }
    html{ font-size:18px }
    body{ font-family:'Outfit',system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--deep); background:var(--sand); margin:0 }
    .card{ border-radius:1.25rem; background:#fff; border:1px solid #e2e8f0; padding:1rem; box-shadow:0 10px 30px rgba(15,23,42,.06) }
    .btn{ border-radius:14px; background:#fff; border:1px solid #e2e8f0; padding:.65rem 1rem; box-shadow:0 2px 10px rgba(15,23,42,.06) }
    .btn:hover{ background:#f8fafc }
    header.sticky{ position:sticky; top:0; backdrop-filter:saturate(140%) blur(6px); background:rgba(255,255,255,.85); border-bottom:1px solid #e2e8f0; z-index:30 }
    .brand img{ height:48px; width:auto }
    .hero{ position:relative; min-height:100vh; display:flex; align-items:center; justify-content:center }
    .hero img.bg{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; opacity:.7 }
    .hero .overlay{ position:relative; z-index:1; display:flex; flex-direction:column; align-items:center; gap:1.25rem }
    .notice { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:50; }
    .notice .box { background:#fff; padding:1rem 1.25rem; border-radius:1rem; box-shadow:0 10px 30px rgba(15,23,42,.15) }
  </style>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const isRoot = () => location.pathname === '/';
    const rulesKey = 'oob_rules_accepted';
    const stripBrackets = (s) => (s||'').replace(/\[[\s\S]*?\]/g, '').replace(/[\[\]]/g,'').trim();

    function App(){
      const [lang] = React.useState(getLang());
      const [data, setData] = React.useState(null);
      const isLanding = isRoot();

      React.useEffect(()=>{
        fetch('/content.json')
          .then(r=>r.json())
          .then(setData)
          .catch(()=>setData({error:true}));
      },[]);

      if(!data) return <div style={{padding:'2rem'}}>Loading…</div>;
      if(data.error) return <div style={{padding:'2rem'}}>Content failed to load.</div>;

      const L = data[lang] || data.he;
      const dir = lang==='he' ? 'rtl' : 'ltr';

      return (
        <div dir={dir}>
          {!isLanding && <Header lang={lang} /> }
          {isLanding ? <Landing /> : <Welcome L={L} lang={lang} /> }
          <footer className="mt-12 py-10 text-center text-xs opacity-60">© {new Date().getFullYear()} Out of the Blue</footer>
        </div>
      );
    }

    function Header({ lang }){
      return (
        <header className="sticky">
          <div className="mx-auto flex max-w-6xl items-center justify-between px-5 py-4">
            <div className="brand"><img src="/brand-logo-v42.png" alt="Out of the Blue"/></div>
            <div className="inline-flex overflow-hidden rounded-2xl border">
              <a href="/welcome?lang=he" className={"px-3 py-2 text-sm "+(lang==='he'?'bg-[var(--sea)] text-white':'bg-white')}>HE</a>
              <a href="/welcome?lang=en" className={"px-3 py-2 text-sm "+(lang==='en'?'bg-[var(--sea)] text-white':'bg-white')}>EN</a>
            </div>
          </div>
        </header>
      );
    }

    function Landing(){
      const accepted = (localStorage.getItem('oob_rules_accepted') === 'yes');
      return (
        <section className="hero">
          <img src="/cover.jpg" alt="" className="bg" />
          <div className="overlay">
            <img src="/brand-logo-v42.png" alt="Out of the Blue" style={{width:'min(85vw, 340px)'}} />
            <div className="flex gap-3 mt-2">
              <a className="rounded-2xl bg-[var(--sea)] text-white px-5 py-3 shadow hover:bg-[var(--sea-600)]"
                 href={accepted ? "/welcome?lang=en" : "/section/rules?lang=en"}>English</a>
              <a className="rounded-2xl bg-[var(--sea)] text-white px-5 py-3 shadow hover:bg-[var(--sea-600)]"
                 href={accepted ? "/welcome?lang=he" : "/section/rules?lang=he"}>עברית</a>
            </div>
          </div>
        </section>
      );
    }

    function Welcome({ L, lang }){
      React.useEffect(()=>{
        if (localStorage.getItem('oob_rules_accepted') !== 'yes') {
          location.href = '/section/rules?lang=' + lang;
        }
      }, [lang]);

      const to = (key) => key==='ask' ? '/ask?lang='+lang : '/section/'+key+'?lang='+lang;
      const hiddenKeys = new Set(['ask','appliances']);

      const menuItems = (L.menu || [])
        .filter(item => item && item.key)
        .filter(item => !hiddenKeys.has(item.key))
        .filter(item => item.enabled !== false);

      return (
        <main className="mx-auto max-w-6xl px-5 py-10">
          <h1 className="text-3xl font-semibold mb-3">{L.welcomeTitle}</h1>
          <p className="opacity-80 mb-6 leading-relaxed">{stripBrackets(L.welcomeIntro)}</p>
          <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
            {menuItems.map(item => (
              <a key={item.key} href={to(item.key)} className="card block hover:shadow-lg transition">
                <div className="text-lg font-semibold mb-1">{item.label}</div>
              </a>
            ))}
          </div>
        </main>
      );
    }

    function extractUrl(s){
      const m = s.match(/https?:\/\/[^\s)\]]+/i);
      return m ? m[0].replace(/[),.]+$/,'') : null;
    }

    function renderUsefulLine(line){
      const text = (line || '').trim();
      const url = extractUrl(text);

      // HEADER: no URL + ends with ":" → bold
      if (!url && text.endsWith(':')) {
        return <p className="mb-3 leading-relaxed"><strong>{text}</strong></p>;
      }

      if (url) {
        const label = text
          .replace(/https?:\/\/[^\s)\]]+/i,'')
          .replace(/[()]/g,'')
          .trim() || 'Open';

        return (
          <p className="mb-3 leading-relaxed">
            <a href={url} target="_blank" rel="noopener">{label}</a>
          </p>
        );
      }

      return <p className="mb-3 leading-relaxed">{text}</p>;
    }

    function getLang(){
      const q=new URLSearchParams(location.search);
      const v=q.get('lang');
      return (v==='en'?'en':'he');
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>

  <link rel="icon" href="/brand-logo-v42.png" />
</body>
</html>
