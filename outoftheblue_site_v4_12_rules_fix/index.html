<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Out of the Blue</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ --deep:#0f172a; --sea:#4fc3dc; --sea-600:#36b2cd; --sand:#fff7e6; }
    html{ font-size:18px }
    body{ font-family:'Outfit',system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--deep); background:var(--sand); margin:0 }
    .card{ border-radius:1.25rem; background:#fff; border:1px solid #e2e8f0; padding:1rem; box-shadow:0 10px 30px rgba(15,23,42,.06) }
    .btn{ border-radius:14px; background:#fff; border:1px solid #e2e8f0; padding:.65rem 1rem; box-shadow:0 2px 10px rgba(15,23,42,.06) }
    .btn:hover{ background:#f8fafc }
    header.sticky{ position:sticky; top:0; backdrop-filter:saturate(140%) blur(6px); background:rgba(255,255,255,.85); border-bottom:1px solid #e2e8f0; z-index:30 }
    .brand img{ height:48px; width:auto }
    .hero{ position:relative; min-height:100vh; display:flex; align-items:center; justify-content:center }
    .hero img.bg{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; opacity:.7 }
    .hero .overlay{ position:relative; z-index:1; display:flex; flex-direction:column; align-items:center; gap:1.25rem }
    .notice { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:50; }
    .notice .box { background:#fff; padding:1rem 1.25rem; border-radius:1rem; box-shadow:0 10px 30px rgba(15,23,42,.15) }

    .useful-link {
      color: var(--deep);
      text-decoration: none;
      border-bottom: 1px solid rgba(15,23,42,0.25);
      cursor: pointer;
    }

    .useful-link:hover {
      color: var(--sea-600);
      border-bottom-color: var(--sea-600);
    }
  </style>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const isRoot = () => location.pathname === '/';
    const rulesKey = 'oob_rules_accepted';
    const stripBrackets = (s) => (s||'').replace(/\[[\s\S]*?\]/g, '').replace(/[\[\]]/g,'').trim();
    const getAccepted = () => { try { return localStorage.getItem(rulesKey) === 'yes'; } catch(e){ return false; } };
    const setAccepted = (v) => { try { localStorage.setItem(rulesKey, v ? 'yes' : 'no'); } catch(e){} };

    function App(){
      const [lang] = React.useState(getLang());
      const [data, setData] = React.useState(null);
      const isLanding = isRoot();

      React.useEffect(()=>{
        fetch('/content.json')
          .then(r=>r.json())
          .then(setData)
          .catch(()=>setData({error:true}));
      },[]);

      if(!data) return <div style={{padding:'2rem'}}>Loadingâ€¦</div>;
      if(data.error) return <div style={{padding:'2rem'}}>Content failed to load.</div>;

      const L = data[lang] || data.he;
      const dir = lang==='he' ? 'rtl' : 'ltr';

      return (
        <div dir={dir}>
          {!isLanding && <Header lang={lang} /> }
          {isLanding ? <Landing /> : <Welcome L={L} lang={lang} /> }
          <footer className="mt-12 py-10 text-center text-xs opacity-60">Â© {new Date().getFullYear()} Out of the Blue</footer>
        </div>
      );
    }

    function Header({ lang }){
      return (
        <header className="sticky">
          <div className="mx-auto flex max-w-6xl items-center justify-between px-5 py-4">
            <div className="brand"><img src="/brand-logo-v42.png" alt="Out of the Blue"/></div>
            <div className="inline-flex overflow-hidden rounded-2xl border">
              <a href="/welcome?lang=he" className={"px-3 py-2 text-sm "+(lang==='he'?'bg-[var(--sea)] text-white':'bg-white')}>HE</a>
              <a href="/welcome?lang=en" className={"px-3 py-2 text-sm "+(lang==='en'?'bg-[var(--sea)] text-white':'bg-white')}>EN</a>
            </div>
          </div>
        </header>
      );
    }

    function Landing(){
      const accepted = (localStorage.getItem('oob_rules_accepted') === 'yes');
      return (
        <section className="hero">
          <img src="/cover.jpg" alt="" className="bg" />
          <div className="overlay">
            <img src="/brand-logo-v42.png" alt="Out of the Blue" style={{width:'min(85vw, 340px)'}} />
            <div className="flex gap-3 mt-2">
              <a className="rounded-2xl bg-[var(--sea)] text-white px-5 py-3 shadow hover:bg-[var(--sea-600)]"
                 href={accepted ? "/welcome?lang=en" : "/section/rules?lang=en"}>
                English
              </a>
              <a className="rounded-2xl bg-[var(--sea)] text-white px-5 py-3 shadow hover:bg-[var(--sea-600)]"
                 href={accepted ? "/welcome?lang=he" : "/section/rules?lang=he"}>
                ×¢×‘×¨×™×ª
              </a>
            </div>
          </div>
        </section>
      );
    }

    function Welcome({ L, lang }){
      // Safety: if not accepted, redirect to rules first
      React.useEffect(()=>{
        if (localStorage.getItem('oob_rules_accepted') !== 'yes') {
          location.href = '/section/rules?lang=' + lang;
        }
      }, [lang]);

      const to = (key) => key==='ask' ? '/ask?lang='+lang : '/section/'+key+'?lang='+lang;

      // Nothing hidden at the moment (you can re-add keys later if needed)
      const hiddenKeys = new Set([]);

      const menuItems = (L.menu || [])
        .filter(item => item && item.key)
        .filter(item => !hiddenKeys.has(item.key))
        .filter(item => item.enabled !== false);

      return (
        <main className="mx-auto max-w-6xl px-5 py-10">
          <h1 className="text-3xl font-semibold mb-3">{L.welcomeTitle}</h1>
          <p className="opacity-80 mb-6 leading-relaxed">{stripBrackets(L.welcomeIntro)}</p>

          <div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
            {menuItems.map((item) => {
              const isRules = item.key === 'rules';
              const isAsk = item.key === 'ask';

              return (
                <a
                  key={item.key}
                  href={to(item.key)}
                  className={
                    (isAsk
                      ? "card block hover:shadow-lg transition border-2 border-[var(--sea)] bg-[rgba(79,195,220,0.10)] sm:col-span-2 lg:col-span-3"
                      : "card block hover:shadow-lg transition")
                  }
                >
                  <div className="flex items-start justify-between gap-3">
                    <div className="text-lg font-semibold mb-1">
                      {item.label}
                      {isRules && (
                        <span className="text-sm opacity-70">
                          {" "}{lang==='he' ? "(×—×•×‘×” ×œ×§×¨×•×)" : "(must read)"}
                        </span>
                      )}
                    </div>

                    {isAsk && (
                      <span className="text-xs px-2 py-1 rounded-full bg-[var(--sea)] text-white whitespace-nowrap">
                        {lang==='he' ? '×¦×³××˜' : 'Chat'}
                      </span>
                    )}
                  </div>

                  {isAsk && (
                    <p className="opacity-75 mt-1 leading-relaxed">
                      {lang==='he'
                        ? '×“×‘×¨×• ×¢× Blue â€” ×”×§×•× ×¡×™××¨×’×³ ×”×“×™×’×™×˜×œ×™ ×©×œ×›×'
                        : 'Chat with Blue â€” your digital concierge'}
                    </p>
                  )}
                </a>
              );
            })}
          </div>
        </main>
      );
    }

    function BackToMenu({lang}){
      return <a className="btn inline-block my-2" href={'/welcome?lang='+lang}>{lang==='he'?'×—×–×¨×” ×œ×ª×¤×¨×™×˜':'Back to main menu'}</a>;
    }

    // Ask page (kept in code; now styled in menu)
// Ask page â€” chat UI + AI via Netlify function
function AskPage({ lang }) {
  const [data, setData] = React.useState(null);
  const [messages, setMessages] = React.useState(() => ([
    {
      role: 'assistant',
      content:
        lang === 'he'
          ? "×”×™×™, ×× ×™ ×‘×œ×• ğŸ‘‹ ×©××œ×• ××•×ª×™ ×›×œ ×“×‘×¨ ×¢×œ ×”×¡×•×•×™×˜×”, ×”×‘× ×™×™×Ÿ ×•×”××–×•×¨. ×× ×™ ×¢×•× ×” ×¨×§ ×œ×¤×™ ×”××™×“×¢ ×‘××“×¨×™×š."
          : "Hi, Iâ€™m Blue ğŸ‘‹ Ask me anything about the suite, the building, and the area. I answer only based on the information in the guide."
    }
  ]));
  const [input, setInput] = React.useState('');
  const [sending, setSending] = React.useState(false);
  const [error, setError] = React.useState('');
  const bottomRef = React.useRef(null);

  const dir = lang === 'he' ? 'rtl' : 'ltr';

  React.useEffect(() => {
    fetch('/content.json')
      .then(r => r.json())
      .then(setData)
      .catch(() => setData({ error: true }));
  }, []);

  React.useEffect(() => {
    bottomRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages, sending]);

  const buildGuideText = (L) => {
    const lines = [];
    const addSection = (title, arr) => {
      if (!arr || !arr.length) return;
      lines.push(`\n## ${title}`);
      arr.forEach(x => lines.push(`- ${x}`));
    };

    addSection(lang === 'he' ? '×—×•×§×™ ×”×‘×™×ª' : 'House rules', L.sections?.rules?.content);
    addSection(lang === 'he' ? '××™×“×¢ ×—×©×•×‘' : 'Important information', L.sections?.info?.content);
    addSection(lang === 'he' ? '××™×“×¢ ×©×™××•×©×™' : 'Useful information', L.sections?.useful?.content);

    const a313 = L.sections?.arrival?.suite313 || [];
    const a413 = L.sections?.arrival?.suite413 || [];
    if (a313.length) addSection(lang === 'he' ? '×”×•×¨××•×ª ×”×’×¢×” Â· ×¡×•×•×™×˜×” 313' : 'Arrival Â· Suite 313', a313);
    if (a413.length) addSection(lang === 'he' ? '×”×•×¨××•×ª ×”×’×¢×” Â· ×¡×•×•×™×˜×” 413' : 'Arrival Â· Suite 413', a413);

    // appliances excluded for now (per your request)
    return lines.join('\n');
  };

  const send = async (e) => {
    e.preventDefault();
    setError('');

    const q = (input || '').trim();
    if (!q || sending) return;

    // show user message immediately
    setMessages(prev => [...prev, { role: 'user', content: q }]);
    setInput('');
    setSending(true);

    try {
      if (!data || data.error) throw new Error('Content not loaded');
      const L = data[lang] || data.he;
      const guide = buildGuideText(L);

      const res = await fetch('/.netlify/functions/concierge', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          lang,
          question: q,
          guide,
          messages: messages.slice(-8).map(m => ({ role: m.role, content: m.content }))
        })
      });

      const json = await res.json().catch(() => ({}));
      if (!res.ok) {
        throw new Error(json?.error || `Request failed (${res.status})`);
      }

      const answer = (json?.answer || '').trim();
      const finalAnswer =
        answer ||
        (lang === 'he'
          ? "×× ×™ ×œ× ××•×¦×/×ª ×ª×©×•×‘×” ×‘××“×¨×™×š ×›×¨×’×¢. ×× ×ª×¨×¦×•, ××¤×©×¨ ×œ×™×¦×•×¨ ×§×©×¨ ×¢× ×”×××¨×—×™×."
          : "I donâ€™t have that in the guide right now. If youâ€™d like, you can contact the hosts.");

      setMessages(prev => [...prev, { role: 'assistant', content: finalAnswer }]);
    } catch (err) {
      console.error(err);
      setError(lang === 'he'
        ? "××©×”×• ×”×©×ª×‘×©. × ×¡×• ×©×•×‘ ×‘×¢×•×“ ×¨×’×¢."
        : "Something went wrong. Please try again in a moment.");

      setMessages(prev => [...prev, {
        role: 'assistant',
        content: lang === 'he'
          ? "×× ×™ ×œ× ××¦×œ×™×—/×” ×œ×¢× ×•×ª ×›×¨×’×¢. ×× ×ª×¨×¦×•, ××¤×©×¨ ×œ×™×¦×•×¨ ×§×©×¨ ×¢× ×”×××¨×—×™×."
          : "I canâ€™t answer right now. If youâ€™d like, you can contact the hosts."
      }]);
    } finally {
      setSending(false);
    }
  };

  const Bubble = ({ role, children }) => {
    const isUser = role === 'user';
    return (
      <div className={"w-full flex " + (isUser ? "justify-end" : "justify-start")}>
        <div className={
          (isUser
            ? "max-w-[85%] rounded-2xl bg-[var(--sea)] text-white px-4 py-3 shadow"
            : "max-w-[85%] rounded-2xl bg-white border border-slate-200 px-4 py-3 shadow-sm")
        }>
          <div className="whitespace-pre-wrap leading-relaxed">{children}</div>
        </div>
      </div>
    );
  };

  return (
    <div dir={dir} className="mx-auto max-w-4xl px-5 py-10">
      <BackToMenu lang={lang} />

      <h1 className="text-3xl font-semibold mb-6">
        {lang === 'he' ? '×©××œ×• ××•×ª×™ ×›×œ ×“×‘×¨' : 'Ask me anything'}
      </h1>

      <div className="space-y-4 mb-6">
        {messages.map((m, i) => (
          <Bubble key={i} role={m.role}>{m.content}</Bubble>
        ))}

        {sending && (
          <Bubble role="assistant">
            {lang === 'he' ? '×—×•×©×‘/×ªâ€¦' : 'Thinkingâ€¦'}
          </Bubble>
        )}

        <div ref={bottomRef} />
      </div>

      <form onSubmit={send} className="flex gap-3 items-center">
        <input
          className="flex-1 border rounded-2xl px-4 py-3 bg-white"
          placeholder={lang === 'he' ? '×›×ª×‘×• ×©××œ×”â€¦' : 'Type a questionâ€¦'}
          value={input}
          onChange={(e) => setInput(e.target.value)}
        />
        <button className="btn px-5" type="submit" disabled={sending}>
          {lang === 'he' ? '×©×œ×—' : 'Send'}
        </button>
      </form>

      {error && <p className="text-sm mt-3 opacity-70">{error}</p>}

      <p className="text-xs mt-4 opacity-60">
        {lang === 'he'
          ? '×‘×œ×• ×¢×•× ×” ×¨×§ ×œ×¤×™ ×”××™×“×¢ ×‘××“×¨×™×š. ×× ××©×”×• ×œ× ××•×¤×™×¢ ×‘×•, ×‘×œ×• ×™×¢×“×™×£ ×œ×”×’×™×“ ×©×œ× ×™×•×“×¢/×ª ×××©×¨ ×œ× ×—×©.'
          : 'Blue answers only from the guide. If something isnâ€™t in it, Blue will say so rather than guessing.'}
      </p>
    </div>
  );
}



    // Rules page content component
    function RulesContent({sec, lang}){
      const [checked,setChecked] = React.useState(false);
      return <div>
        {(sec?.content||[]).map((p,i)=>(<p key={i} className="mb-3 leading-relaxed">{p}</p>))}
        <div className="mt-4 flex items-center gap-2">
          <input id="acceptRules" type="checkbox" checked={checked} onChange={e=>setChecked(e.target.checked)} />
          <label htmlFor="acceptRules">{lang==='he'?'××¡×›×™×/×” ×œ×—×•×§×™ ×”×‘×™×ª':'I accept the house rules'}</label>
        </div>
        <button className="btn mt-3" disabled={!checked} onClick={()=>{ try{localStorage.setItem('oob_rules_accepted','yes');}catch(e){}; location.href='/welcome?lang='+lang; }}>
          {lang==='he'?'××™×©×•×¨':'Accept'}
        </button>
      </div>;
    }

    // Router
    const path = location.pathname;

    // Global gate: require accepting house rules before accessing anything (except landing + rules page)
    const langForGate = getLang();
    const acceptedForGate = (localStorage.getItem('oob_rules_accepted') === 'yes');
    const isRulesPage = path === '/section/rules' || path.startsWith('/section/rules/');
    const isLandingPage = path === '/';

    if (!acceptedForGate && !isLandingPage && !isRulesPage) {
      location.replace('/section/rules?lang=' + langForGate);
    }

    if(path==='/ask'){
      const lang = getLang();
      ReactDOM.createRoot(document.getElementById('root')).render(<AskPage lang={lang}/>);
    } else if(path.startsWith('/section/')){
      const parts = path.split('/').filter(Boolean);
      const key = parts[1];
      const suite = parts[2];
      const lang = getLang();

      fetch('/content.json').then(r=>r.json()).then(data=>{
        const L = data[lang] || data.he;
        const dir = lang==='he' ? 'rtl' : 'ltr';
        const root = document.getElementById('root');

        if((key==='arrival'||key==='appliances') && (suite==='313' || suite==='413')){
          const sec = L.sections[key];
          const content = suite==='313' ? (sec.suite313||[]) : (sec.suite413||[]);
          ReactDOM.createRoot(root).render(
            <div dir={dir}>
              <Header lang={lang} />
              <main className="mx-auto max-w-3xl px-5 py-10">
                <BackToMenu lang={lang}/>
                <h1 className="text-3xl font-semibold mb-6">{(key==='arrival' ? (lang==='he'?'×”×•×¨××•×ª ×”×’×¢×” ×•×›× ×™×¡×”':'Arrival essentials') : (lang==='he'?'×”×•×¨××•×ª ×©×™××•×© ×‘××›×©×™×¨×™×':'Appliance instructions'))+' Â· '+(lang==='he'?(suite==='313'?'×¡×•×•×™×˜×” 313':'×¡×•×•×™×˜×” 413'):('Suite '+suite))}</h1>
                {content.map((p,i)=>(<p key={i} className="mb-3 leading-relaxed">{p}</p>))}
              </main>
            </div>
          );
        } else if(key==='arrival' || key==='appliances'){
          ReactDOM.createRoot(root).render(
            <div dir={dir}>
              <Header lang={lang} />
              <main className="mx-auto max-w-3xl px-5 py-10">
                <BackToMenu lang={lang}/>
                <h1 className="text-3xl font-semibold mb-6">{key==='arrival' ? (lang==='he'?'×”×•×¨××•×ª ×”×’×¢×” ×•×›× ×™×¡×”':'Arrival essentials') : (lang==='he'?'×”×•×¨××•×ª ×©×™××•×© ×‘××›×©×™×¨×™×':'Appliance instructions')}</h1>
                <div className="grid gap-4 sm:grid-cols-2">
                  <a className="card block" href={'/section/'+key+'/313?lang='+lang}>
                    <h2 className="text-xl font-semibold mb-2">{lang==='he'?'×¡×•×•×™×˜×” 313':'Suite 313'}</h2>
                    <p className="opacity-80">{lang==='he'?'×”×•×¨××•×ª ×œ×¡×•×•×™×˜×” 313':'Instructions for Suite 313'}</p>
                  </a>
                  <a className="card block" href={'/section/'+key+'/413?lang='+lang}>
                    <h2 className="text-xl font-semibold mb-2">{lang==='he'?'×¡×•×•×™×˜×” 413':'Suite 413'}</h2>
                    <p className="opacity-80">{lang==='he'?'×”×•×¨××•×ª ×œ×¡×•×•×™×˜×” 413':'Instructions for Suite 413'}</p>
                  </a>
                </div>
              </main>
            </div>
          );
        } else if(key==='info' || key==='useful' || key==='rules'){
          const sec = L.sections[key];
          ReactDOM.createRoot(root).render(
            <div dir={dir}>
              <Header lang={lang} />
              <main className="mx-auto max-w-3xl px-5 py-10">
                <BackToMenu lang={lang}/>
                <h1 className="text-3xl font-semibold mb-6">{sec?.title || key}</h1>
                {key==='rules' ? <RulesContent sec={sec} lang={lang}/> :
                 key==='info' ? (sec?.content||[]).map((p,i)=> <React.Fragment key={i}>{renderInfoLine(p)}</React.Fragment>) :
                 (sec?.content||[]).map((p,i)=> <React.Fragment key={i}>{renderUsefulLine(p)}</React.Fragment>)}
              </main>
            </div>
          );
        }
      }).catch(()=>{ document.getElementById('root').innerHTML = '<div style="padding:2rem">Failed to load content.</div>'; });
    } else {
      ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
    }

    function getLang(){
      const q=new URLSearchParams(location.search);
      const v=q.get('lang');
      return (v==='en'?'en':'he');
    }
  </script>

  <link rel="icon" href="/brand-logo-v42.png" />
</body>
</html>
